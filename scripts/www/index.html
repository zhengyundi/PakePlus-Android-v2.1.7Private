<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>WiFiç‚¹å¯¹ç‚¹èŠå¤©</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      background: #0F172A;
      color: #F1F5F9;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* é¡¶éƒ¨å¯¼èˆª */
    .top-bar {
      background: #1E293B;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #334155;
    }
    .top-bar h1 {
      font-size: 18px;
      font-weight: 600;
    }
    .room-info {
      font-size: 13px;
      color: #94A3B8;
    }
    /* åœ¨çº¿ç”¨æˆ·æ  */
    .peers-bar {
      background: #1E293B;
      padding: 8px 16px;
      display: flex;
      gap: 12px;
      overflow-x: auto;
      border-bottom: 1px solid #334155;
    }
    .peer-item {
      padding: 6px 12px;
      background: #334155;
      border-radius: 16px;
      font-size: 13px;
      white-space: nowrap;
      cursor: pointer;
    }
    .peer-item.active {
      background: #3B82F6;
    }
    /* æ¶ˆæ¯åŒº */
    .messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 18px;
      line-height: 1.4;
      position: relative;
    }
    .msg.other {
      background: #1E293B;
      align-self: flex-start;
    }
    .msg.self {
      background: #3B82F6;
      color: white;
      align-self: flex-end;
    }
    .msg-name {
      font-size: 12px;
      color: #94A3B8;
      margin-bottom: 4px;
    }
    .msg-img {
      max-width: 200px;
      border-radius: 12px;
      margin-top: 4px;
    }
    /* è¾“å…¥åŒº */
    .input-bar {
      background: #1E293B;
      padding: 10px;
      display: flex;
      gap: 8px;
      border-top: 1px solid #334155;
    }
    #img-btn {
      width: 44px;
      height: 44px;
      border-radius: 22px;
      background: #334155;
      border: none;
      color: #F1F5F9;
      font-size: 18px;
      cursor: pointer;
    }
    #msg-input {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 22px;
      background: #334155;
      color: #F1F5F9;
      outline: none;
      font-size: 15px;
    }
    #send-btn {
      padding: 0 20px;
      height: 44px;
      border-radius: 22px;
      background: #3B82F6;
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    #send-btn:active {
      opacity: 0.8;
    }
    /* æˆ¿é—´é€‰æ‹©å¼¹çª— */
    .room-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .room-box {
      background: #1E293B;
      padding: 24px;
      border-radius: 16px;
      width: 80%;
      max-width: 320px;
    }
    .room-box h2 {
      font-size: 18px;
      margin-bottom: 16px;
      text-align: center;
    }
    .room-input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: #334155;
      border: none;
      color: #F1F5F9;
      margin-bottom: 12px;
      outline: none;
    }
    .room-btn {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: #3B82F6;
      color: white;
      border: none;
      font-weight: 600;
      margin-bottom: 8px;
      cursor: pointer;
    }
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    .messages::-webkit-scrollbar, .peers-bar::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }
    .messages::-webkit-scrollbar-thumb, .peers-bar::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 2px;
    }
    /* éšè—æ–‡ä»¶è¾“å…¥ */
    #file-input {
      display: none;
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨æ  -->
  <div class="top-bar">
    <h1>WiFiç‚¹å¯¹ç‚¹èŠå¤©</h1>
    <div class="room-info" id="room-display">æˆ¿é—´ï¼šå…¬å…±å¤§å…</div>
  </div>

  <!-- åœ¨çº¿ç”¨æˆ· -->
  <div class="peers-bar" id="peers-list">
    <div class="peer-item active" onclick="switchChat('public')">å…¬å…±å¤§å…</div>
  </div>

  <!-- æ¶ˆæ¯åŒº -->
  <div class="messages" id="msg-container"></div>

  <!-- è¾“å…¥åŒº -->
  <div class="input-bar">
    <button id="img-btn" onclick="document.getElementById('file-input').click()">ğŸ“·</button>
    <input type="file" id="file-input" accept="image/*" onchange="sendImage()">
    <input type="text" id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
    <button id="send-btn" onclick="sendMessage()">å‘é€</button>
  </div>

  <!-- æˆ¿é—´é€‰æ‹©å¼¹çª— -->
  <div class="room-modal" id="room-modal" style="display:none">
    <div class="room-box">
      <h2>é€‰æ‹©æˆ¿é—´</h2>
      <input type="text" class="room-input" id="room-input" placeholder="è¾“å…¥æˆ¿é—´å·">
      <button class="room-btn" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
      <button class="room-btn" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
      <button class="room-btn" style="background:#475569" onclick="closeRoomModal()">å–æ¶ˆ</button>
    </div>
  </div>

  <script>
    // å…¨å±€é…ç½®
    const msgContainer = document.getElementById('msg-container');
    const msgInput = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');
    const peersList = document.getElementById('peers-list');
    const roomDisplay = document.getElementById('room-display');
    const roomModal = document.getElementById('room-modal');
    const roomInput = document.getElementById('room-input');

    const myId = Math.random().toString(36).slice(2, 10);
    let currentChat = 'public'; // å½“å‰èŠå¤©å¯¹è±¡ï¼špublic æˆ– å¯¹æ–¹ID
    let currentRoom = 'public'; // å½“å‰æˆ¿é—´
    const peers = new Map(); // å­˜å‚¨æ‰€æœ‰è¿æ¥
    const peerNames = new Map(); // å­˜å‚¨ç”¨æˆ·æ˜µç§°

    // ========== æˆ¿é—´ç®¡ç† ==========
    function openRoomModal() {
      roomModal.style.display = 'flex';
    }
    function closeRoomModal() {
      roomModal.style.display = 'none';
    }
    function createRoom() {
      const room = roomInput.value.trim() || Math.random().toString(36).slice(2, 8);
      joinRoom(room);
    }
    function joinRoom(room = null) {
      room = room || roomInput.value.trim();
      if (!room) return;
      currentRoom = room;
      roomDisplay.textContent = `æˆ¿é—´ï¼š${room}`;
      closeRoomModal();
      addSystemMsg(`å·²è¿›å…¥æˆ¿é—´ï¼š${room}`);
    }

    // ========== åˆ‡æ¢èŠå¤©ï¼ˆå…¬å…±/ç§èŠï¼‰ ==========
    function switchChat(targetId) {
      currentChat = targetId;
      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.peer-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.classList.add('active');
      // æ¸…ç©ºè¾“å…¥æ¡†
      msgInput.value = '';
    }

    // ========== å‘é€æ¶ˆæ¯ ==========
    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;
      // æ„é€ æ¶ˆæ¯
      const msg = {
        type: 'text',
        from: myId,
        name: 'ç”¨æˆ·', // å¯æ”¹ä¸ºè‡ªå®šä¹‰æ˜µç§°
        room: currentRoom,
        target: currentChat,
        content: text
      };
      // å‘é€ç»™æ‰€æœ‰è¿æ¥
      broadcast(msg);
      // æœ¬åœ°æ˜¾ç¤º
      addMessage(msg, true);
      msgInput.value = '';
    }

    // ========== å‘é€å›¾ç‰‡ ==========
    function sendImage() {
      const file = document.getElementById('file-input').files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const msg = {
          type: 'image',
          from: myId,
          name: 'ç”¨æˆ·',
          room: currentRoom,
          target: currentChat,
          content: e.target.result
        };
        broadcast(msg);
        addMessage(msg, true);
      };
      reader.readAsDataURL(file);
    }

    // ========== å¹¿æ’­æ¶ˆæ¯ ==========
    function broadcast(msg) {
      peers.forEach(({ dc }) => {
        if (dc.readyState === 'open') {
          dc.send(JSON.stringify(msg));
        }
      });
    }

    // ========== æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢ ==========
    function addMessage(msg, isSelf) {
      // åªæ˜¾ç¤ºå½“å‰æˆ¿é—´å’Œå½“å‰èŠå¤©å¯¹è±¡çš„æ¶ˆæ¯
      if (msg.room !== currentRoom || msg.target !== currentChat) return;
      
      const div = document.createElement('div');
      div.className = `msg ${isSelf ? 'self' : 'other'}`;
      
      if (!isSelf) {
        const nameSpan = document.createElement('div');
        nameSpan.className = 'msg-name';
        nameSpan.textContent = msg.name;
        div.appendChild(nameSpan);
      }
      
      if (msg.type === 'text') {
        const textSpan = document.createElement('div');
        textSpan.textContent = msg.content;
        div.appendChild(textSpan);
      } else if (msg.type === 'image') {
        const img = document.createElement('img');
        img.src = msg.content;
        img.className = 'msg-img';
        div.appendChild(img);
      }
      
      msgContainer.appendChild(div);
      msgContainer.scrollTop = msgContainer.scrollHeight;
    }

    // ========== ç³»ç»Ÿæ¶ˆæ¯ ==========
    function addSystemMsg(text) {
      const div = document.createElement('div');
      div.style.textAlign = 'center';
      div.style.color = '#94A3B8';
      div.style.fontSize = '12px';
      div.style.margin = '8px 0';
      div.textContent = text;
      msgContainer.appendChild(div);
      msgContainer.scrollTop = msgContainer.scrollHeight;
    }

    // ========== åˆå§‹åŒ– ==========
    // ç»‘å®šå›è½¦å‘é€
    msgInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendMessage();
    });

    // é•¿æŒ‰é¡¶éƒ¨æ æ‰“å¼€æˆ¿é—´é€‰æ‹©
    document.querySelector('.top-bar').addEventListener('longpress', openRoomModal);
    document.querySelector('.top-bar').addEventListener('click', e => {
      if (e.target === document.querySelector('.top-bar h1')) openRoomModal();
    });

    // æ¨¡æ‹Ÿè‡ªåŠ¨å‘ç°ï¼ˆæ‰“åŒ…APPåæ›¿æ¢ä¸ºåŸç”ŸUDPï¼‰
    function startDiscovery() {
      addSystemMsg('æ­£åœ¨æœç´¢åŒä¸€WiFiä¸‹çš„è®¾å¤‡...');
      // è¿™é‡Œé¢„ç•™åŸç”ŸUDPå‘ç°æ¥å£
    }

    // å¯åŠ¨
    startDiscovery();
  </script>
</body>
</html>